<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lá»‹ch sá»­ giao dá»‹ch - EggHead</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

 <link rel="stylesheet" href="/css/main.css">
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-light bg-gradient px-3 custom-navbar align-items-center">
    <img src="/img/552783237_1095201732776549_4395309577322638889_n.svg" alt="logo" width="100" height="80">
    <a class="navbar-brand" href="/trang_chu/dashboard">EggHead</a>

    <div class="position-relative ms-auto d-flex align-items-center me-3">
      <button id="bellBtn" class="btn btn-sm btn-outline-secondary position-relative me-2 btn-notify bell-custom"
        aria-label="ThÃ´ng bÃ¡o">
        <i class="fa-solid fa-bell"></i>
        <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle"
          id="notifyCount">0</span>
      </button>
      <div id="notificationBox" class="d-none position-absolute bg-white shadow p-2"
        style="top:90%; right:83px; width:280px; z-index:1000;">
        <h6 class="mb-2">ThÃ´ng bÃ¡o</h6>
        <ul id="notificationList" class="list-unstyled m-0 p-0"></ul>
      </div>
    </div>

    <div class="position-relative">
      <button id="userBtn" class="btn p-0 border-0 bg-transparent" aria-haspopup="true" aria-expanded="false"
        aria-controls="userMenu">
        <img src="https://i.pravatar.cc/300" alt="Avatar" class="user-avatar" id="userAvatar">
      </button>

      <div id="userMenu" class="position-absolute end-0 mt-2 user-dropdown bg-white d-none" role="menu"
        aria-labelledby="userBtn">
        <div class="profile-top">
          <img src="https://i.pravatar.cc/300" alt="Avatar small">
          <div class="meta">
            <div class="name" id="menuName">
              <%= user_details.username %>
            </div>
            <div class="small" id="menuEmail">
              <%= user_details.email %>
            </div>
            <div class="money" id="money">Sá»‘ dÆ°: <%= balance.toLocaleString() %>Ä‘</div>
          </div>
        </div>
        <div class="profile-actions">
          <a href="#" id="viewProfile" role="menuitem"><i class="fa-regular fa-user"></i> <span>Xem há»“ sÆ¡</span></a>
          <a href="#" id="settings" role="menuitem"><i class="fa-solid fa-gear"></i> <span>CÃ i Ä‘áº·t</span></a>
          <button class="dropdown-item toggle-theme">ğŸŒ™ Cháº¿ Ä‘á»™ tá»‘i</button>
          <div class="dropdown-divider"></div>
          <a href="/logout" id="logout" role="menuitem" class="text-danger"><i
              class="fa-solid fa-right-from-bracket"></i> <span>ÄÄƒng xuáº¥t</span></a>
        </div>
      </div>
    </div>
  </nav>
  <div class="d-flex">
    <div class="sidebar d-flex flex-column p-3">
      <div class="sidebar-header mb-3 d-flex justify-content-between align-items-center">
        <span class="fw-bold text-black">EggHead</span>
        <button class="btn btn-sm btn-outline-dark toggle-btn"><i class="fa-solid fa-bars"></i></button>
      </div>

      <div class="chat-list flex-grow-1 overflow-auto">
        <a href="/trang_chu/dashboard" class="chat-item">
          <i class="fa-solid fa-house"></i><span>Trang chá»§</span>
        </a>

        <a href="#" class="chat-item has-submenu">
          <i class="fa-solid fa-money-bill-wave"></i>
          <span>Chá»‰nh sá»­a ngÃ¢n sÃ¡ch</span>
        </a>
        <div class="submenu" style="display:none; padding-left:20px;">
          <a href="/trang_chu/Budget" class="chat-item">â• ThÃªm ngÃ¢n sÃ¡ch</a>
          <a href="/trang_chu/viewbud" class="chat-item">âœï¸ Chá»‰nh sá»­a ngÃ¢n sÃ¡ch</a>
        </div>

        <a href="#" class="chat-item has-submenu">
          <i class="fa-solid fa-piggy-bank"></i>
          <span>Chá»‰nh sá»­a chi tiÃªu</span>
        </a>
        <div class="submenu" style="display:none; padding-left:20px;">
          <a href="/trang_chu/themchitieu" class="chat-item">â• ThÃªm chi tiÃªu</a>
          <a href="/trang_chu/chinhsuachitieu" class="chat-item">âœï¸ Chá»‰nh sá»­a khoáº£n chi</a>
        </div>

        <a href="/trang_chu/charts" class="chat-item"><i class="fa-solid fa-chart-simple"></i><span>Biá»ƒu Ä‘á»“</span></a>
        <a href="/trang_chu/charts" class="chat-item active"><i class="fa-solid fa-timeline"></i><span>Lá»‹ch sá»­ giao
            dá»‹ch</span></a>
      </div>
    </div>

    <div id="main-content" class="content flex-grow-1 p-4">

      <!-- MAIN CONTENT: Lá»ŠCH Sá»¬ GIAO Dá»ŠCH -->
      <div class="container-fluid px-4 py-4">
        <!-- TiÃªu Ä‘á» -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="fw-bold m-0" style="color: black;">Lá»‹ch sá»­ giao dá»‹ch</h3>
          <button id="exportBtn" class="btn btn-outline-success"
            onclick="window.location.href = `/trang_chu/history/export?fromDate=<%= fromDate %>&toDate=<%= toDate %>&type=<%= type %>`">
            <i class="fa-solid fa-file-export me-2"></i>Xuáº¥t dá»¯ liá»‡u
          </button>
        </div>

        <!-- Bá»™ lá»c -->
        <form id="filterForm" action="/trang_chu/history" method="POST" class="bg-white p-4 rounded-3 shadow-sm mb-4">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="fromDate" class="form-label fw-semibold text-secondary">
                <i class="fa-regular fa-calendar-days me-1"></i>Tá»« ngÃ y
              </label>
              <input type="date" class="form-control" name="fromDate" value="<%= fromDate || '' %>">
            </div>

            <div class="col-md-4">
              <label for="toDate" class="form-label fw-semibold text-secondary">
                <i class="fa-regular fa-calendar-check me-1"></i>Äáº¿n ngÃ y
              </label>
              <input type="date" class="form-control" name="toDate" value="<%= toDate || '' %>">
            </div>

            <div class="col-md-3">
              <label for="type" class="form-label fw-semibold text-secondary">
                <i class="fa-solid fa-filter me-1"></i>Loáº¡i giao dá»‹ch
              </label>
              <select class="form-select" name="type">
                <option value="all" <%=type==='all' ? 'selected' : '' %>>Táº¥t cáº£</option>
                <option value="income" <%=type==='income' ? 'selected' : '' %>>Thu nháº­p</option>
                <option value="expense" <%=type==='expense' ? 'selected' : '' %>>Chi tiÃªu</option>
              </select>
            </div>

            <div class="col-md-1 d-grid">
              <button type="submit" class="btn btn-primary fw-semibold">
                <i class="fa-solid fa-magnifying-glass me-1"></i>Lá»c
              </button>
            </div>
          </div>
        </form>

        <!-- Thá»‘ng kÃª tá»•ng -->
        <div class="row text-center mb-4 g-3">
          <div class="col-md-4">
            <div class="card shadow-sm border-success">
              <div class="card-body">
                <h6 class="text-success">Tá»•ng thu</h6>
                <h4 id="totalIncome" class="fw-bold text-success">
                  <%= total_income.toLocaleString('vi-VN') %>â‚«
                </h4>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card shadow-sm border-danger">
              <div class="card-body">
                <h6 class="text-danger">Tá»•ng chi</h6>
                <h4 id="totalExpense" class="fw-bold text-danger">
                  <%= total_expense.toLocaleString('vi-VN') %>â‚«
                </h4>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card shadow-sm border-primary">
              <div class="card-body">
                <h6 class="text-primary">Sá»‘ dÆ° cÃ²n láº¡i</h6>
                <h4 id="balance" class="fw-bold text-primary">
                  <%= balance.toLocaleString('vi-VN') %>â‚«
                </h4>
              </div>
            </div>
          </div>
        </div>

        <!-- Báº£ng giao dá»‹ch -->
        <div class="table-responsive shadow-sm rounded-3">
          <table id="transactionTable" class="table table-hover align-middle mb-0">
            <thead class="table-primary">
              <tr>
                <th>#</th>
                <th>NgÃ y</th>
                <th>MÃ´ táº£</th>
                <th>NgÃ¢n sÃ¡ch</th>
                <th>Loáº¡i</th>
                <th>Sá»‘ tiá»n</th>
              </tr>
            </thead>
            <tbody>
              <% transactions.forEach((t, index)=> { %>
                <tr data-type="<%= t.type %>">
                  <td>
                    <%= index + 1 %>
                  </td>
                  <td>
                    <%= new Date(t.date).toLocaleDateString('vi-VN') %>
                  </td>
                  <td>
                    <%= t.transaction_name %>
                  </td>
                  <td>
                    <%= t.budget_id || 'ChÆ°a cÃ³' %>
                  </td>
                  <td>
                    <span class="badge <%= t.type === 'income' ? 'bg-success' : 'bg-danger' %>">
                      <%= t.type==='income' ? 'Thu' : 'Chi' %>
                    </span>
                  </td>
                  <td class="<%= t.type === 'income' ? 'text-success' : 'text-danger' %>">
                    <%= t.type==='income' ? '+' : '-' %>
                      <%= t.amount.toLocaleString('vi-VN') %>â‚«
                  </td>
                </tr>
                <% }) %>

                  <% if (transactions.length===0) { %>
                    <tr>
                      <td colspan="6" class="text-center text-muted">KhÃ´ng cÃ³ giao dá»‹ch nÃ o</td>
                    </tr>
                    <% } %>
            </tbody>
          </table>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const bellBtn = document.getElementById("bellBtn");
            const notificationBox = document.getElementById("notificationBox");
            const notificationList = document.getElementById("notificationList");
            const userBtn = document.getElementById("userBtn");
            const userMenu = document.getElementById("userMenu");

            // Báº¥m chuÃ´ng -> hiá»‡n thÃ´ng bÃ¡o
            if (bellBtn && notificationBox) {
              bellBtn.addEventListener("click", async (e) => {
                e.stopPropagation();
                notificationBox.classList.toggle("d-none");

                // Náº¿u báº­t há»™p thÃ¬ load thÃ´ng bÃ¡o
                if (!notificationBox.classList.contains("d-none")) {
                  const res = await fetch("/trang_chu/notification");
                  const data = await res.json();

                  notificationList.innerHTML = "";

                  if (data.notifyList && data.notifyList.length > 0) {
                    data.notifyList.forEach(n => {
                      const li = document.createElement("li");
                      li.classList.add("border-bottom", "py-1");
                      li.textContent = n.message;
                      notificationList.appendChild(li);
                    });
                  } else {
                    notificationList.innerHTML = "<li class='text-muted'>KhÃ´ng cÃ³ thÃ´ng bÃ¡o má»›i</li>";
                  }
                }
              });
            }

            // Menu ngÆ°á»i dÃ¹ng
            if (userBtn && userMenu) {
              userBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                userMenu.classList.toggle("d-none");
              });
            }

            // Click ra ngoÃ i -> áº©n má»i popup
            document.addEventListener("click", (e) => {
              if (!notificationBox.classList.contains("d-none") &&
                !notificationBox.contains(e.target) &&
                !bellBtn.contains(e.target)) {
                notificationBox.classList.add("d-none");
              }
              if (!userMenu.classList.contains("d-none") &&
                !userMenu.contains(e.target) &&
                !userBtn.contains(e.target)) {
                userMenu.classList.add("d-none");
              }
            });
          });
        </script>
        <script>
          // ====== SIDEBAR TOGGLE (THU Gá»ŒN) ======
          const toggleBtn = document.querySelector('.toggle-btn');
          const sidebar = document.querySelector('.sidebar');
          if (toggleBtn && sidebar) {
            toggleBtn.addEventListener('click', () => {
              sidebar.classList.toggle('collapsed');
            });
          }

          // ====== SIDEBAR SUBMENU (MENU CON) ======
          document.querySelectorAll(".has-submenu").forEach(parent => {
            parent.addEventListener("click", function (e) {
              if (this.getAttribute('href') === '#') {
                e.preventDefault();
              }
              const submenu = this.nextElementSibling;
              if (submenu && submenu.classList.contains('submenu')) {
                submenu.style.display = (submenu.style.display === "block") ? "none" : "block";
              }
            });
          });
        </script>
        <script>
Â  Â  Â  // ===== LOGIC Xá»¬ LÃ DARK MODE =====
Â  Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  Â  const themeToggleButton = document.querySelector('.toggle-theme');
Â  Â  Â  Â  const body = document.body;

Â  Â  Â  Â  // 1. HÃ m Cáº­p nháº­t nÃºt báº¥m (thay Ä‘á»•i chá»¯ SÃ¡ng/Tá»‘i)
Â  Â  Â  Â  function updateButtonText() {
Â  Â  Â  Â  Â  if (body.classList.contains('dark-mode')) {
Â  Â  Â  Â  Â  Â  themeToggleButton.innerHTML = 'â˜€ï¸ Cháº¿ Ä‘á»™ sÃ¡ng';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  themeToggleButton.innerHTML = 'ğŸŒ™ Cháº¿ Ä‘á»™ tá»‘i';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Kiá»ƒm tra cháº¿ Ä‘á»™ Ä‘Ã£ lÆ°u trong localStorage khi táº£i trang
Â  Â  Â  Â  const savedTheme = localStorage.getItem('theme');
Â  Â  Â  Â  if (savedTheme === 'dark') {
Â  Â  Â  Â  Â  body.classList.add('dark-mode');
Â  Â  Â  Â  }
Â  Â  Â  Â  // Cáº­p nháº­t chá»¯ trÃªn nÃºt lÃºc táº£i trang
Â  Â  Â  Â  if (themeToggleButton) {
Â  Â  Â  Â  Â  updateButtonText();
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. Láº¯ng nghe sá»± kiá»‡n click vÃ o nÃºt
Â  Â  Â  Â  if (themeToggleButton) {
Â  Â  Â  Â  Â  themeToggleButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  // Báº­t/táº¯t class 'dark-mode' trÃªn body
Â  Â  Â  Â  Â  Â  body.classList.toggle('dark-mode');

Â  Â  Â  Â  Â  Â  // Cáº­p nháº­t láº¡i chá»¯ trÃªn nÃºt
Â  Â  Â  Â  Â  Â  updateButtonText();

Â  Â  Â  Â  Â  Â  // LÆ°u lá»±a chá»n vÃ o localStorage
Â  Â  Â  Â  Â  Â  if (body.classList.contains('dark-mode')) {
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('theme', 'dark');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('theme', 'light');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  </script>

</body>
</html>

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/src/public/js/history.js"></script>
</body>

</html>